source("@CMAKE_BINARY_DIR@/src/test/loadtestenv.m");

testjob = "@CMAKE_CURRENT_SOURCE_DIR@/1345_970_11.job";
ground_dem_file = "@CMAKE_CURRENT_SOURCE_DIR@/synth-ground-DEM.tif";
ground_drg_file = "@CMAKE_CURRENT_SOURCE_DIR@/synth-ground-DRG.tif";

[tile_georef images settings] = loadjobfile(testjob);

[ground_dem ground_georef] = imread_vw(ground_dem_file);
[ground_drg] = imread_vw(ground_drg_file);

function result = geotrans(image, from_georef, to_georef, sz)
  %% Draw DEM on tile
  P = inv(from_georef.transform) * to_georef.transform;
  [X Y] = meshgrid(1:sz(2), 1:sz(1));
  D = [X(:) Y(:) ones(prod(sz), 1)]';
  PD = P * D;

  xw = reshape(PD(1,:) ./ PD(3,:), sz(2), sz(1));
  yw = reshape(PD(2,:) ./ PD(3,:), sz(2), sz(1));

  result = imremap(image, xw, yw, "bilinear");
endfunction

tile_dem = geotrans(ground_dem, ground_georef, tile_georef, [256 256]);
